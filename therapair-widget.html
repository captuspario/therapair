<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Therapair Widget - Updated</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Open Sans', ui-sans-serif, system-ui, sans-serif;
            background-color: #F8F4FF;
            padding: 1rem;
            min-height: 100vh;
        }

        .container {
            max-width: 72rem;
            margin: 0 auto;
        }

        .chat-bubble {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .progress-dot {
            transition: all 0.3s ease;
        }

        .progress-dot.active {
            background-color: #9B74B7;
            transform: scale(1.2);
        }

        .option-button {
            transition: all 0.2s ease;
            cursor: pointer;
            background-color: #9B74B7;
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 20px;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            width: 100%;
            text-align: left;
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        .option-button:hover {
            background-color: #4F064F;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(155, 116, 183, 0.25);
        }

        .option-button.selected {
            background-color: #4F064F;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(155, 116, 183, 0.3);
        }

        .option-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .option-button:disabled.selected {
            opacity: 1;
            background-color: #4F064F;
        }

        /* Multiple choice styling */
        .option-button.multiple-choice {
            background-color: white;
            color: #374151;
            border: 2px solid #d1d5db;
        }

        .option-button.multiple-choice:hover {
            background-color: #f9fafb;
            border-color: #9B74B7;
        }

        .option-button.multiple-choice.selected {
            background-color: #9B74B7;
            color: white;
            border-color: #9B74B7;
        }

        .therapist-card {
            transition: all 0.3s ease;
            background: white;
            border-radius: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .therapist-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .therapist-card img {
            width: 100%;
            height: 250px;
            object-fit: cover;
            background-color: #f3f4f6;
            transition: all 0.3s ease;
        }

        .therapist-card img:hover {
            filter: brightness(1.05);
        }

        .chat-message {
            background-color: white;
            border-radius: 16px;
            padding: 16px 20px;
            margin: 8px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .chat-message.bot {
            text-align: left;
            color: #374151;
            font-weight: 500;
        }

        .white-panel {
            background-color: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin: 24px auto;
            max-width: 48rem;
        }

        .btn-primary {
            background-color: #9B74B7;
            color: white;
            padding: 1rem 2rem;
            border-radius: 16px;
            border: none;
            font-weight: 600;
            font-size: 1.125rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            background-color: #4F064F;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(155, 116, 183, 0.25);
        }

        .therapist-grid {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            margin: 2rem 0;
        }

        .therapist-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .results-tier {
            margin-bottom: 2rem;
        }

        .results-tier h3 {
            color: #4F064F;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
        }

        .results-tier p {
            color: #6B7280;
            text-align: center;
            margin-bottom: 2rem;
        }

        .specialty-tag {
            background-color: #9B74B7;
            color: white;
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            margin: 0.25rem 0.25rem 0.25rem 0;
            display: inline-block;
        }

        .progress-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .progress-dots {
            display: flex;
            gap: 0.5rem;
        }

        .progress-dot {
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 50%;
            background-color: #d1d5db;
        }

        .text-center {
            text-align: center;
        }

        .hidden {
            display: none;
        }

        .card-content {
            padding: 1.5rem;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .card-buttons {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .btn-secondary {
            width: 100%;
            background: white;
            border: 2px solid #9B74B7;
            color: #374151;
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background-color: #f9fafb;
        }

        .btn-book {
            width: 100%;
            background-color: #9B74B7;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }

        .btn-book:hover {
            background-color: #4F064F;
            box-shadow: 0 4px 12px rgba(155, 116, 183, 0.25);
        }

        .continue-btn {
            background-color: #9B74B7;
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
            transition: all 0.2s ease;
        }

        .continue-btn:hover {
            background-color: #4F064F;
            transform: translateY(-2px);
        }

        .continue-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .therapist-cards-grid {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 0.5rem;
            }

            .white-panel {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Hero Section -->
        <div class="text-center" style="margin-bottom: 2rem;">
            <h1 style="color: #111827; margin-bottom: 1rem; font-size: 2.5rem; font-weight: 700; line-height: 1.2; max-width: 42rem; margin-left: auto; margin-right: auto;">
                Let's find a therapist who's right for you
            </h1>
            <p style="color: #6b7280; margin-bottom: 2rem; font-size: 1.125rem; max-width: 36rem; margin-left: auto; margin-right: auto;">
                Answer a few quick questions — we'll guide you to someone who really gets it.
            </p>
            <button
                id="start-btn"
                onclick="startMatching()"
                class="btn-primary"
            >
                Start Matching
            </button>
        </div>

        <!-- Chat Interface -->
        <div id="chat-interface" class="hidden">
            <div class="white-panel">
                <!-- Progress Bar -->
                <div class="progress-container">
                    <div class="progress-dots" id="progress-dots">
                        <!-- Progress dots will be added dynamically -->
                    </div>
                    <span id="progress-text" style="font-size: 0.875rem; color: #6b7280;">1 of ?</span>
                </div>

                <!-- Chat Messages -->
                <div id="chat-messages" style="margin-bottom: 1.5rem;">
                    <!-- Messages will be added here dynamically -->
                </div>

                <!-- Options Container -->
                <div id="options-container">
                    <!-- Options will be added here dynamically -->
                </div>

                <!-- Continue Button for Multiple Choice -->
                <div id="continue-container" class="hidden text-center">
                    <button id="continue-btn" class="continue-btn" onclick="continueToNext()" disabled>
                        Continue
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="hidden">
            <div id="results-header" class="text-center" style="margin-bottom: 2rem;">
                <h2 style="color: #111827; margin-bottom: 1rem; font-size: 1.875rem; font-weight: 700;">Here are your matches</h2>
                <p style="color: #6b7280; font-size: 1.125rem; max-width: 36rem; margin-left: auto; margin-right: auto;">
                    Let's find a therapist who's right for you<br>
                    Answer a few quick questions — we'll guide you to someone who really gets it
                </p>
            </div>

            <div id="therapist-cards" class="therapist-grid">
                <!-- Therapist cards will be added here -->
            </div>

            <div class="text-center" style="margin-top: 2rem;">
                <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 1rem;">Not quite right?</p>
                <div>
                    <button onclick="restartQuiz()" style="color: #9B74B7; text-decoration: underline; background: none; border: none; cursor: pointer; margin-right: 1rem; font-size: 0.875rem;">
                        Retake quiz
                    </button>
                    <button style="color: #9B74B7; text-decoration: underline; background: none; border: none; cursor: pointer; font-size: 0.875rem;">
                        Explore all therapists
                    </button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center" style="margin-top: 4rem; padding-top: 2rem; border-top: 1px solid #e5e7eb;">
            <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">
                Powered by Therapair for Unison
            </p>
            <p style="font-size: 0.75rem; color: #9ca3af;">
                Find mental health support that understands you
            </p>
        </div>
    </div>

    <script>
        // Image paths for root directory deployment
        const IMAGE_PATHS = [
            '/images/therapair/',
            '/therapair-images/',
            '/images/',
            './images/therapair/',
            './images/'
        ];

        function getImagePath(filename) {
            for (let path of IMAGE_PATHS) {
                const fullPath = path + filename;
                return fullPath;
            }
            return filename;
        }

        // Updated therapist data with new information
        const therapists = [
            {
                name: "Nicki Nelis",
                gender: "female",
                image: getImagePath("nicki-nelis-therapair-counsellor.jpg"),
                tagline: "Gestalt therapist with nearly 20 years' experience, specializing in LGBTQI+, trauma survivors, and kink/ENM communities",
                specialties: ["LGBTQI+ affirming", "Trauma survivors", "Kink community", "ENM relationships", "Sexual assault survivors", "Gestalt Therapy", "Psychodynamic Therapy"],
                availability: "In-person Windsor (Thursdays 10am–7pm)",
                tags: ["lgbtq", "trauma", "kink", "enm", "identity", "gestalt", "psychodynamic", "sexual_health", "addiction", "disability"],
                accepting: true,
                whoSupported: ["myself", "someone_else"],
                ageGroups: ["adult", "under_18", "mixed"],
                locations: ["in_person"],
                funding: ["vocat", "fas", "ndis", "disability_pension"],
                availability_days: ["thursday"],
                urgency: ["few_weeks", "wait_for_right"],
                approaches: ["gestalt", "emotion_focused", "somatic", "psychodynamic", "mindfulness", "trauma"],
                communities: ["lgbtq", "kink", "disability"]
            },
            {
                name: "Adam Forman",
                gender: "male",
                image: getImagePath("adam-forman-therapair-counsellor.jpg"),
                tagline: "Counsellor & Mediator with two decades experience working with young people and adults, specializing in ethically non-monogamous relationships",
                specialties: ["ENM relationships", "Opening relationships", "Relationship dynamics", "Attachment healing", "Mediation"],
                availability: "Online & in-person Fitzroy North (Flexible)",
                tags: ["enm", "relationship", "mediation", "young_people", "disability"],
                accepting: true,
                whoSupported: ["myself", "myself_partner", "someone_else"],
                ageGroups: ["adult", "under_18", "mixed"],
                locations: ["online", "in_person"],
                funding: ["vocat", "fas", "ndis", "disability_pension"],
                availability_days: ["monday", "tuesday", "wednesday", "thursday", "friday"],
                urgency: ["asap", "fortnight", "few_weeks", "wait_for_right"],
                approaches: ["relationship", "mindfulness", "trauma", "psychodynamic"],
                communities: ["disability", "open"]
            },
            {
                name: "Natasha Lama",
                gender: "female",
                image: getImagePath("natasha-lama-therapair-sex-therapist.jpg"),
                tagline: "Counsellor & Sex Therapist with cultural sensitivity, specializing in sex-positive approaches and cultural identity",
                specialties: ["Sex therapy", "Cultural sensitivity", "Sexual health", "Cultural identity", "CBT", "Mindfulness"],
                availability: "Online and in-person Windsor (Mondays noon–7pm, Saturdays 9am–2pm)",
                tags: ["sexual_health", "cultural", "sex_positive", "cbt", "schema"],
                accepting: true,
                whoSupported: ["myself", "myself_partner", "someone_else"],
                ageGroups: ["adult"],
                locations: ["online", "in_person"],
                funding: ["vocat", "fas", "ndis", "disability_pension"],
                availability_days: ["monday", "saturday"],
                urgency: ["asap", "fortnight", "few_weeks", "wait_for_right"],
                approaches: ["cbt_dbt", "mindfulness", "trauma", "schema", "relationship", "somatic", "psychodynamic"],
                communities: ["cultural", "kink", "open"]
            },
            {
                name: "Genevieve Autret",
                gender: "female",
                image: getImagePath("genevieve-autret-therapair-psychotherapist.jpg"),
                tagline: "Psychotherapist with 15+ years experience, specializing in psychedelic integration, relationship therapy and trauma-informed therapy",
                specialties: ["Psychedelic integration", "Trauma therapy", "DBT", "Art therapy", "Harm reduction", "Couples therapy"],
                availability: "Online (Tuesdays 4:30–6:30pm, Wednesdays noon–6pm)",
                tags: ["psychedelic", "trauma", "art_therapy", "couples", "dbt"],
                accepting: true,
                whoSupported: ["myself", "myself_partner", "someone_else"],
                ageGroups: ["adult"],
                locations: ["online"],
                funding: ["vocat", "fas", "ndis", "disability_pension"],
                availability_days: ["monday", "tuesday", "wednesday", "thursday", "friday"],
                urgency: ["asap", "fortnight", "few_weeks", "wait_for_right"],
                approaches: ["art", "dbt", "mindfulness", "trauma", "relationship", "psychedelic", "somatic", "psychodynamic"],
                communities: ["open"]
            },
            {
                name: "Emma Steains",
                gender: "female",
                image: getImagePath("emma-steains-therapair-clinical-psychologist.jpg"),
                tagline: "Clinical Psychologist specializing in veterans/ADF personnel, EMDR, ACT, and trauma recovery",
                specialties: ["EMDR", "ACT", "CBT", "Veteran support", "ADF families", "Trauma recovery", "Internal Family Systems"],
                availability: "Online (Wednesdays 2–6pm, Fridays 9am–5pm)",
                tags: ["emdr", "veterans", "trauma", "cbt", "act", "ifs"],
                accepting: true,
                whoSupported: ["myself", "someone_else"],
                ageGroups: ["adult", "under_18", "mixed"],
                locations: ["online"],
                funding: ["mental_health_plan", "open_arms", "vocat", "fas", "ndis", "disability_pension", "workcover"],
                availability_days: ["wednesday", "friday"],
                urgency: ["few_weeks", "wait_for_right"],
                approaches: ["cbt_dbt", "mindfulness", "trauma", "internal_family", "somatic", "psychodynamic"],
                communities: ["veterans", "disability", "open"]
            },
            {
                name: "Michael Spurrier",
                gender: "male",
                image: getImagePath("michael-spurrier-therapair-clinical-psychologist.jpg"),
                tagline: "Clinical Psychologist providing warm, grounded therapy for trauma, relationships, neurodivergence, mood, and addiction",
                specialties: ["Trauma therapy", "Relationship work", "Neurodivergent support", "Mood disorders", "Addiction", "Schema therapy"],
                availability: "Online (Mondays 9am–3pm)",
                tags: ["trauma", "relationship", "addiction", "neurodivergent", "mood", "schema"],
                accepting: true,
                whoSupported: ["myself", "myself_partner", "someone_else"],
                ageGroups: ["adult", "under_18", "mixed"],
                locations: ["online"],
                funding: ["mental_health_plan", "open_arms", "vocat", "fas", "ndis", "disability_pension", "workcover"],
                availability_days: ["monday"],
                urgency: ["fortnight", "few_weeks", "wait_for_right"],
                approaches: ["cbt_dbt", "mindfulness", "trauma", "relationship", "schema", "psychedelic", "psychodynamic"],
                communities: ["disability", "open"]
            },
            {
                name: "Meg Wilson",
                gender: "female",
                image: getImagePath("meg-wilson-therapair-psychotherapist.jpg"),
                tagline: "Founder & Psychotherapist with over 12 years experience in relationship therapy, DBT/trauma-informed therapy, and art therapy",
                specialties: ["Art psychotherapy", "DBT", "Mindfulness", "Relationship therapy", "Non-traditional relationships"],
                availability: "Online (Mondays 10am to 6pm) / in-person Windsor (Tuesdays and Wednesdays 2pm to 8pm)",
                tags: ["art_therapy", "relationship", "founder", "dbt", "non_traditional"],
                accepting: true, // Updated from the copy
                whoSupported: ["myself", "myself_partner", "someone_else"],
                ageGroups: ["adult"],
                locations: ["online", "in_person"],
                funding: ["vocat", "fas", "ndis", "disability_pension"],
                availability_days: ["monday", "tuesday", "wednesday"],
                urgency: ["few_weeks", "wait_for_right"],
                approaches: ["art", "cbt_dbt", "mindfulness", "trauma", "relationship", "psychedelic", "somatic", "psychodynamic"],
                communities: ["lgbtq", "kink", "disability", "open"]
            },
            {
                name: "Joe Stark",
                gender: "male",
                image: getImagePath("joe-stark-therapair-psychiatrist.jpg"),
                tagline: "Psychiatrist & Psychotherapist, pioneer in psychedelic-assisted therapy and mindfulness teacher",
                specialties: ["Psychiatry", "Psychedelic therapy", "Mindfulness", "Chronic pain", "Trauma", "Anxiety"],
                availability: "Not accepting new clients; medication-assisted treatments by enquiry",
                tags: ["psychedelic", "psychiatry", "mindfulness", "chronic_pain"],
                accepting: false,
                whoSupported: ["myself", "someone_else"],
                ageGroups: ["adult"],
                locations: ["online"],
                funding: ["vocat", "fas", "ndis", "disability_pension"],
                availability_days: [],
                urgency: [],
                approaches: ["mindfulness", "trauma", "psychedelic", "psychodynamic"],
                communities: ["open"]
            }
        ];

        // Adaptive question flow with conditional logic
        const questionFlow = [
            {
                id: "who",
                text: "Who is seeking therapy?",
                type: "single",
                options: [
                    { text: "For myself", value: "myself" },
                    { text: "For myself and my partner(s)", value: "myself_partner" },
                    { text: "For someone else", value: "someone_else" }
                ]
            },
            {
                id: "age",
                text: "Is the person(s) seeking therapy over 18?",
                type: "single",
                options: [
                    { text: "Yes", value: "adult" },
                    { text: "No", value: "under_18" },
                    { text: "One person is over 18 and one person is under 18", value: "mixed" }
                ]
            },
            {
                id: "location",
                text: "Our practice is located in Melbourne but we also offer telehealth sessions via zoom, which option is better for you?",
                type: "single",
                options: [
                    { text: "Online Appointments", value: "online" },
                    { text: "In-person Appointments", value: "in_person" },
                    { text: "Either online or in-person", value: "either" }
                ]
            },
            {
                id: "concerns",
                text: "What brings you to therapy?",
                type: "multiple",
                options: [
                    { text: "Relationship challenges", value: "relationship" },
                    { text: "Anxiety or depression", value: "anxiety_depression" },
                    { text: "Trauma or PTSD", value: "trauma" },
                    { text: "Identity exploration", value: "identity" },
                    { text: "Sexual health concerns", value: "sexual_health" },
                    { text: "Psychedelic therapy/integration", value: "psychedelic" },
                    { text: "Addiction recovery", value: "addiction" },
                    { text: "General Support", value: "general" }
                ]
            },
            {
                id: "funding",
                text: "Do any of the following funding options apply to you?",
                type: "multiple",
                options: [
                    { text: "Mental Health Care Plan", value: "mental_health_plan" },
                    { text: "Open Arms / ADF", value: "open_arms" },
                    { text: "VOCAT or FAS", value: "vocat_fas" },
                    { text: "NDIS", value: "ndis" },
                    { text: "Disability Pension", value: "disability_pension" },
                    { text: "Workcover", value: "workcover" },
                    { text: "None of these apply", value: "none" }
                ]
            },
            {
                id: "availability",
                text: "Please select each day of the week you are available for therapy. The more days you choose the more matches you will get.",
                type: "multiple",
                options: [
                    { text: "Monday", value: "monday" },
                    { text: "Tuesday", value: "tuesday" },
                    { text: "Wednesday", value: "wednesday" },
                    { text: "Thursday", value: "thursday" },
                    { text: "Friday", value: "friday" },
                    { text: "Saturday", value: "saturday" },
                    { text: "I'm flexible with timing", value: "flexible" }
                ]
            },
            {
                id: "urgency",
                text: "When would you ideally start therapy?",
                type: "single",
                note: "We are not a crisis service and therefore unable to offer same-day or last minute appointments.",
                options: [
                    { text: "ASAP", value: "asap" },
                    { text: "Sometime in the next fortnight", value: "fortnight" },
                    { text: "Happy to wait a few weeks", value: "few_weeks" },
                    { text: "I don't mind waiting for the right therapist", value: "wait_for_right" }
                ]
            },
            {
                id: "approach",
                text: "What type of therapy approach interests you most?",
                type: "multiple",
                options: [
                    { text: "Art-based therapy", value: "art" },
                    { text: "CBT/DBT skills-focused", value: "cbt_dbt" },
                    { text: "Mindfulness/acceptance-based", value: "mindfulness" },
                    { text: "Trauma-specific approaches", value: "trauma" },
                    { text: "Gestalt", value: "gestalt" },
                    { text: "Emotion-focused Therapy (EMDR)", value: "emotion_focused" },
                    { text: "Somatic Therapy", value: "somatic" },
                    { text: "Internal Family Systems", value: "internal_family" },
                    { text: "Psychedelic Integration", value: "psychedelic" },
                    { text: "Schema Therapy", value: "schema" },
                    { text: "Psychodynamic approach", value: "psychodynamic" },
                    { text: "Relationship Therapy", value: "relationship" },
                    { text: "No preference/unsure", value: "no_preference" }
                ]
            },
            {
                id: "community",
                text: "Are there specific communities or experiences that are important to you?",
                type: "multiple",
                options: [
                    { text: "LGBTQIA+ community", value: "lgbtq" },
                    { text: "Kink community", value: "kink" },
                    { text: "Cultural/ethnic minority", value: "cultural" },
                    { text: "Disability or Chronic illness", value: "disability" },
                    { text: "Veterans/ADF personnel or family", value: "veterans" },
                    { text: "I'm open to any qualified therapist", value: "open" }
                ]
            },
        ];

        let currentQuestionIndex = 0;
        let responses = {};
        let selectedMultipleChoices = [];
        let activeQuestions = [];

        function startMatching() {
            currentQuestionIndex = 0;
            responses = {};
            selectedMultipleChoices = [];

            // Determine which questions to show based on initial logic
            activeQuestions = [...questionFlow];

            document.getElementById('chat-messages').innerHTML = '';
            document.getElementById('options-container').innerHTML = '';
            document.getElementById('continue-container').classList.add('hidden');

            updateProgressDots();
            document.getElementById('progress-text').textContent = '1 of ' + activeQuestions.length;
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('chat-interface').classList.remove('hidden');

            showQuestion(0);
        }

        function updateProgressDots() {
            const progressDots = document.getElementById('progress-dots');
            progressDots.innerHTML = '';

            for (let i = 0; i < activeQuestions.length; i++) {
                const dot = document.createElement('div');
                dot.className = 'progress-dot';
                if (i <= currentQuestionIndex) {
                    dot.classList.add('active');
                }
                progressDots.appendChild(dot);
            }
        }

        function showQuestion(index) {
            currentQuestionIndex = index;
            const question = activeQuestions[index];

            updateProgressDots();
            document.getElementById('progress-text').textContent = `${index + 1} of ${activeQuestions.length}`;

            document.getElementById('chat-messages').innerHTML = '';
            document.getElementById('options-container').innerHTML = '';
            document.getElementById('continue-container').classList.add('hidden');

            // Add question as chat bubble
            let questionText = question.text;
            if (question.note) {
                questionText += `<br><small style="color: #6b7280; font-style: italic;">${question.note}</small>`;
            }
            addChatBubble(questionText, 'bot');

            selectedMultipleChoices = [];

            setTimeout(() => {
                question.options.forEach((option, i) => {
                    setTimeout(() => {
                        addOptionButton(option, question.type);
                    }, i * 100);
                });

                if (question.type === 'multiple') {
                    document.getElementById('continue-container').classList.remove('hidden');
                }
            }, 500);
        }

        function addChatBubble(message, sender) {
            const chatMessages = document.getElementById('chat-messages');
            const bubble = document.createElement('div');

            if (sender === 'bot') {
                bubble.className = 'chat-message bot';
                bubble.innerHTML = message;
            } else {
                bubble.className = 'chat-bubble';
                bubble.style.display = 'flex';
                bubble.style.justifyContent = 'flex-end';
                bubble.innerHTML = `
                    <div style="max-width: 20rem; padding: 0.75rem 1rem; border-radius: 1rem; color: white; background-color: #9B74B7;">
                        ${message}
                    </div>
                `;
            }

            chatMessages.appendChild(bubble);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addOptionButton(option, questionType) {
            const container = document.getElementById('options-container');
            const button = document.createElement('button');

            if (questionType === 'multiple') {
                button.className = 'option-button multiple-choice';
                button.onclick = () => toggleMultipleChoice(option, button);
            } else {
                button.className = 'option-button';
                button.onclick = () => selectSingleOption(option, button);
            }

            button.textContent = option.text;
            container.appendChild(button);
        }

        function toggleMultipleChoice(option, buttonElement) {
            const index = selectedMultipleChoices.findIndex(choice => choice.value === option.value);

            if (index > -1) {
                // Remove from selection
                selectedMultipleChoices.splice(index, 1);
                buttonElement.classList.remove('selected');
            } else {
                // Add to selection
                selectedMultipleChoices.push(option);
                buttonElement.classList.add('selected');
            }

            // Enable/disable continue button
            const continueBtn = document.getElementById('continue-btn');
            continueBtn.disabled = selectedMultipleChoices.length === 0;
        }

        function continueToNext() {
            const question = activeQuestions[currentQuestionIndex];
            responses[question.id] = selectedMultipleChoices.map(choice => choice.value);

            proceedToNext();
        }

        function selectSingleOption(option, buttonElement) {
            const question = activeQuestions[currentQuestionIndex];

            buttonElement.classList.add('selected');
            buttonElement.disabled = true;

            responses[question.id] = option.value;

            // Disable other options
            const allOptions = document.querySelectorAll('.option-button');
            allOptions.forEach(opt => opt.disabled = true);

            setTimeout(() => {
                proceedToNext();
            }, 1000);
        }

        function proceedToNext() {
            // Adaptive logic - modify questions based on responses
            adaptQuestionFlow();

            if (currentQuestionIndex < activeQuestions.length - 1) {
                showQuestion(currentQuestionIndex + 1);
            } else {
                showResults();
            }
        }

        function adaptQuestionFlow() {
            // Example adaptive logic - can be expanded
            // Skip certain questions based on responses

            // If someone else is seeking therapy, might skip personal preference questions
            if (responses.who === 'someone_else') {
                // Could adapt certain questions here
            }

            // If only online selected, skip location-specific questions
            if (responses.location === 'online') {
                // Remove in-person specific logic
            }
        }

        function showResults() {
            document.getElementById('chat-interface').classList.add('hidden');
            document.getElementById('results-section').classList.remove('hidden');

            const matchResults = getMatchedTherapists();
            displayTieredResults(matchResults);
        }

        function getMatchedTherapists() {
            // Start with all accepting therapists
            let allTherapists = therapists.filter(t => t.accepting);
            let bestMatches = [];
            let eligibleTherapists = [...allTherapists];

            // Apply strict filters for best matches
            // Who they support
            if (responses.who) {
                eligibleTherapists = eligibleTherapists.filter(t =>
                    t.whoSupported.includes(responses.who)
                );
            }

            // Age groups
            if (responses.age) {
                eligibleTherapists = eligibleTherapists.filter(t =>
                    t.ageGroups.includes(responses.age)
                );
            }

            // Location preference (unless 'either')
            if (responses.location && responses.location !== 'either') {
                eligibleTherapists = eligibleTherapists.filter(t =>
                    t.locations.includes(responses.location)
                );
            }

            // Funding options
            if (responses.funding && responses.funding.length > 0) {
                eligibleTherapists = eligibleTherapists.filter(t =>
                    responses.funding.some(funding => t.funding.includes(funding))
                );
            }

            // Availability days (unless 'flexible')
            if (responses.availability && responses.availability.length > 0 && !responses.availability.includes('flexible')) {
                eligibleTherapists = eligibleTherapists.filter(t =>
                    responses.availability.some(day => t.availability_days.includes(day))
                );
            }

            // Score and match based on specialties
            const scoredMatches = [];

            eligibleTherapists.forEach(therapist => {
                let score = 0;

                // Score based on concerns/specialties
                if (responses.concerns) {
                    const concernsArray = Array.isArray(responses.concerns) ? responses.concerns : [responses.concerns];
                    concernsArray.forEach(concern => {
                        switch(concern) {
                            case 'relationship':
                                if (therapist.tags.includes('relationship')) score += 3;
                                break;
                            case 'trauma':
                                if (therapist.tags.includes('trauma')) score += 3;
                                break;
                            case 'sexual_health':
                                if (therapist.tags.includes('sexual_health')) score += 3;
                                break;
                            case 'psychedelic':
                                if (therapist.tags.includes('psychedelic')) score += 3;
                                break;
                            case 'addiction':
                                if (therapist.tags.includes('addiction')) score += 3;
                                break;
                            case 'identity':
                                if (therapist.tags.includes('identity')) score += 3;
                                break;
                            default:
                                score += 1; // General support
                        }
                    });
                }

                // Score based on community preferences
                if (responses.community) {
                    const communityArray = Array.isArray(responses.community) ? responses.community : [responses.community];
                    communityArray.forEach(community => {
                        if (community !== 'open' && therapist.communities.includes(community)) {
                            score += 2;
                        }
                    });
                }

                // Score based on approach preferences
                if (responses.approach) {
                    const approachArray = Array.isArray(responses.approach) ? responses.approach : [responses.approach];
                    approachArray.forEach(approach => {
                        if (approach !== 'no_preference' && therapist.approaches.includes(approach)) {
                            score += 2;
                        }
                    });
                }

                scoredMatches.push({ therapist, score });
            });

            // Sort by score (highest first)
            scoredMatches.sort((a, b) => b.score - a.score);

            // Get best matches (score > 0 - actual matches)
            bestMatches = scoredMatches
                .filter(match => match.score > 0)
                .map(match => match.therapist)
                .slice(0, 3);

            // Create fallback options from remaining eligible therapists
            let fallbackMatches = scoredMatches
                .map(match => match.therapist)
                .filter(therapist => !bestMatches.includes(therapist))
                .slice(0, 3);

            // If no direct matches (score > 0), treat all as fallbacks
            if (bestMatches.length === 0) {
                // Use top scored eligible therapists as fallbacks (not best matches)
                bestMatches = scoredMatches.slice(0, 3).map(match => match.therapist);
                fallbackMatches = [];

                // If still no matches, use all accepting therapists
                if (bestMatches.length === 0) {
                    bestMatches = allTherapists.slice(0, 3);
                }

                // Mark these as fallback-only results
                return {
                    bestMatches: bestMatches,
                    fallbackMatches: [],
                    isDirectMatch: false
                };
            }

            return {
                bestMatches: bestMatches,
                fallbackMatches: fallbackMatches,
                isDirectMatch: true
            };
        }

        function displayTieredResults(matchResults) {
            const container = document.getElementById('therapist-cards');
            const headerElement = document.getElementById('results-header');
            container.innerHTML = ''; // Clear existing content

            // Check if we have actual direct matches vs fallback only
            const hasDirectMatches = matchResults.isDirectMatch;

            if (!hasDirectMatches) {
                // No direct matches - show only fallback section with updated header
                headerElement.innerHTML = `
                    <h2 style="color: #111827; margin-bottom: 1rem; font-size: 1.875rem; font-weight: 700;">Therapists closest to your preferences</h2>
                    <p style="color: #6b7280; font-size: 1.125rem; max-width: 36rem; margin-left: auto; margin-right: auto;">
                        These therapists may also be a good fit
                    </p>
                `;

                const fallbackSection = document.createElement('div');
                fallbackSection.className = 'results-tier';
                container.appendChild(fallbackSection);

                const fallbackCardsContainer = document.createElement('div');
                fallbackCardsContainer.className = 'therapist-cards-grid';
                fallbackSection.appendChild(fallbackCardsContainer);

                matchResults.bestMatches.forEach((therapist, index) => {
                    setTimeout(() => {
                        const card = createTherapistCard(therapist);
                        fallbackCardsContainer.appendChild(card);
                    }, index * 200);
                });
            } else {
                // We have direct matches - show tiered results
                headerElement.innerHTML = `
                    <h2 style="color: #111827; margin-bottom: 1rem; font-size: 1.875rem; font-weight: 700;">Here are your matches</h2>
                    <p style="color: #6b7280; font-size: 1.125rem; max-width: 36rem; margin-left: auto; margin-right: auto;">
                        Let's find a therapist who's right for you<br>
                        Answer a few quick questions — we'll guide you to someone who really gets it
                    </p>
                `;

                // Display best matches section
                const bestSection = document.createElement('div');
                bestSection.className = 'results-tier';
                bestSection.innerHTML = `
                    <h3 style="color: #4F064F; font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem; text-align: center;">
                        Most suitable therapist(s)
                    </h3>
                    <p style="color: #6B7280; text-align: center; margin-bottom: 2rem;">
                        Based on your responses, we think you'll connect well with:
                    </p>
                `;
                container.appendChild(bestSection);

                const bestCardsContainer = document.createElement('div');
                bestCardsContainer.className = 'therapist-cards-grid';
                bestSection.appendChild(bestCardsContainer);

                matchResults.bestMatches.forEach((therapist, index) => {
                    setTimeout(() => {
                        const card = createTherapistCard(therapist);
                        bestCardsContainer.appendChild(card);
                    }, index * 200);
                });

                // Display fallback matches section
                if (matchResults.fallbackMatches.length > 0) {
                    setTimeout(() => {
                        const fallbackSection = document.createElement('div');
                        fallbackSection.className = 'results-tier';
                        fallbackSection.style.marginTop = '3rem';
                        fallbackSection.innerHTML = `
                            <h3 style="color: #4F064F; font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem; text-align: center;">
                                Therapists closest to your preferences
                            </h3>
                            <p style="color: #6B7280; text-align: center; margin-bottom: 2rem;">
                                These therapists may also be a good fit:
                            </p>
                        `;
                        container.appendChild(fallbackSection);

                        const fallbackCardsContainer = document.createElement('div');
                        fallbackCardsContainer.className = 'therapist-cards-grid';
                        fallbackSection.appendChild(fallbackCardsContainer);

                        matchResults.fallbackMatches.forEach((therapist, index) => {
                            setTimeout(() => {
                                const card = createTherapistCard(therapist);
                                fallbackCardsContainer.appendChild(card);
                            }, (index + matchResults.bestMatches.length) * 200);
                        });
                    }, matchResults.bestMatches.length * 200 + 500);
                }
            }
        }

        function displayTherapistCards(therapists) {
            const container = document.getElementById('therapist-cards');

            therapists.forEach((therapist, index) => {
                setTimeout(() => {
                    const card = createTherapistCard(therapist);
                    container.appendChild(card);
                }, index * 200);
            });
        }

        function createTherapistCard(therapist) {
            const card = document.createElement('div');
            card.className = 'therapist-card';

            // Generate gradient fallback
            const nameHash = therapist.name.split('').reduce((a, b) => {
                a = ((a << 5) - a) + b.charCodeAt(0);
                return a & a;
            }, 0);
            const hue = Math.abs(nameHash) % 360;
            const fallbackGradient = `linear-gradient(45deg, hsl(${hue}, 70%, 60%), hsl(${(hue + 60) % 360}, 70%, 70%))`;

            card.innerHTML = `
                <div style="position: relative;">
                    <img
                        src="${therapist.image}"
                        alt="${therapist.name} - Therapist at Therapair"
                        style="width: 100%; height: 250px; object-fit: cover; background: ${fallbackGradient};"
                        onerror="this.style.background='${fallbackGradient}'; this.style.display='none'; this.nextElementSibling.style.display='flex';"
                    />
                    <div style="display: none; width: 100%; height: 250px; ${fallbackGradient}; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2rem;">
                        ${therapist.name.split(' ').map(n => n[0]).join('')}
                    </div>
                </div>

                <div class="card-content">
                    <div style="margin-bottom: 1rem;">
                        <h3 style="color: #111827; margin-bottom: 0.5rem; font-size: 1.25rem; font-weight: 700; margin-top: 0;">${therapist.name}</h3>
                        <p style="color: #6b7280; font-size: 0.875rem; line-height: 1.5; margin: 0;">${therapist.tagline}</p>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.75rem; font-weight: 500; margin-top: 0;">Specializes in:</p>
                        <div>
                            ${therapist.specialties.slice(0, 3).map(specialty => `
                                <span class="specialty-tag">${specialty}</span>
                            `).join('')}
                            ${therapist.specialties.length > 3 ? `
                                <span style="background-color: #f9fafb; color: #6b7280; border: 1px solid #e5e7eb; padding: 0.375rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; margin: 0.25rem 0.25rem 0.25rem 0; display: inline-block;">
                                    +${therapist.specialties.length - 3} more
                                </span>
                            ` : ''}
                        </div>
                    </div>

                    <div class="card-buttons">
                        <button class="btn-secondary" onclick="alert('Profile feature coming soon!')">
                            View Profile
                        </button>
                        <button class="btn-book" onclick="alert('Booking feature coming soon!')">
                            Book Now
                        </button>
                    </div>
                </div>
            `;

            return card;
        }

        function restartQuiz() {
            currentQuestionIndex = 0;
            responses = {};
            selectedMultipleChoices = [];

            document.getElementById('chat-messages').innerHTML = '';
            document.getElementById('options-container').innerHTML = '';
            document.getElementById('continue-container').classList.add('hidden');

            document.getElementById('results-section').classList.add('hidden');
            document.getElementById('chat-interface').classList.remove('hidden');
            document.getElementById('start-btn').style.display = 'none';

            const therapistCards = document.getElementById('therapist-cards');
            if (therapistCards) {
                therapistCards.innerHTML = '';
            }

            startMatching();
        }
    </script>
</body>
</html>